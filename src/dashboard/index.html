<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecommerce Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fafbfc;
            min-height: 100vh;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: none;
            margin: 0;
            background: white;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #581c87 100%);
            color: white;
            padding: 1rem 3rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            /* margin-bottom: 0.5rem; */
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .nav-tabs {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0 3rem;
            display: flex;
            justify-content: flex-start;
            gap: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: #6b7280;
            padding: 1.25rem 2rem;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
            position: relative;
        }

        .nav-tab:hover {
            color: #374151;
            background: #f9fafb;
        }

        .nav-tab.active {
            color: #1e3a8a;
            border-bottom-color: #1e3a8a;
            background: #f8fafc;
        }

        .tab-content {
            display: none;
            padding: 2rem 3rem;
        }

        .tab-content.active {
            display: block;
        }

        .upload-section {
            background: #f9fafb;
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            margin-bottom: 2rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #1e3a8a;
            background: #f0f4ff;
        }

        .upload-section.dragover {
            border-color: #1e3a8a;
            background: #e0e7ff;
        }

        .upload-btn {
            background: #1e3a8a;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            margin: 0.5rem;
        }

        .upload-btn:hover {
            background: #1e40af;
            transform: translateY(-1px);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
            width: 100%;
        }

        .chart-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s ease;
            width: 100%;
        }

        .chart-container:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart {
            width: 100%;
            height: 400px;
            padding: 10px;
        }

        .chart-container.pie-chart {
            grid-column: span 1;
        }

        .chart-container.half-width {
            grid-column: span 1;
        }

        .chart-container.line-chart,
        .chart-container.bar-chart {
            grid-column: span 2;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #1e3a8a, #3730a3);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border-color: #d1d5db;
        }

        .stat-card h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #111827;
        }

        .stat-card p {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .prediction-form {
            background: #f9fafb;
            padding: 2rem;
            border-radius: 12px;
            margin-top: 2rem;
            border: 1px solid #e5e7eb;
            color: #1a1a1a;
        }

        .btn {
            background: #1e3a8a;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: #1e40af;
            transform: translateY(-1px);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1e3a8a;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
            font-size: 1rem;
        }

        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #dc2626;
            font-size: 0.875rem;
        }

        .success {
            background: #ffffff;
            color: #16a34a;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #16a34a;
            font-size: 0.875rem;
        }

        .message {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            font-size: 0.875rem;
        }

        .message.show {
            transform: translateX(0);
        }

        .message.success {
            background: #16a34a;
        }

        .message.error {
            background: #dc2626;
        }

        /* Responsive Design */
        @media (min-width: 1400px) {
            .charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            }
        }

        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container.line-chart,
            .chart-container.bar-chart {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1.5rem 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                padding: 0 1rem;
                overflow-x: auto;
            }
            
            .nav-tab {
                padding: 1rem 1.5rem;
                white-space: nowrap;
            }
            
            .tab-content {
                padding: 1.5rem 1rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
            }
            
            .chart {
                height: 300px;
            }
            
            .charts-grid {
                gap: 1rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .chart {
                height: 250px;
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .file-info {
            background: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .chart {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Ecommerce Analysis Dashboard</h1>
            <p>Comprehensive sales analysis and prediction platform</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('overview')">üìä Overview</button>
            <button class="nav-tab" onclick="showTab('returns')">üîÑ Returns</button>
            <button class="nav-tab" onclick="showTab('predictions')">üîÆ Predictions</button>
            <button class="nav-tab" onclick="showTab('forecasting')">üìä Forecasting</button>
            <button class="nav-tab" onclick="showTab('analysis')">üìã Analysis</button>
        </div>

        <!-- Upload functionality removed - using fixed Jan-June 2025 data -->

        <!-- Overview Tab -->
        <div id="overview" class="tab-content">
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated here -->
            </div>

            <div class="charts-grid">
                <div class="chart-container line-chart">
                    <div class="chart-title">üìà Monthly Sales Trend</div>
                    <div id="salesTrendChart" class="chart"></div>
                </div>

                <div class="chart-container bar-chart">
                    <div class="chart-title">üìä Daily Sales Pattern (Last 30 Days)</div>
                    <div id="dailySalesChart" class="chart"></div>
                </div>

                <div class="chart-container bar-chart">
                    <div class="chart-title">üì¶ Top 10 SKUs by Sales Volume</div>
                    <div id="skuChart" class="chart"></div>
                </div>

                <div class="chart-container bar-chart">
                    <div class="chart-title">üí∞ Top 10 SKUs by Revenue</div>
                    <div id="revenueChart" class="chart"></div>
                </div>

                <div class="chart-container pie-chart">
                    <div class="chart-title">üó∫Ô∏è Geographic Distribution</div>
                    <div id="geoChart" class="chart"></div>
                </div>

                <div class="chart-container bar-chart">
                    <div class="chart-title">üõí Flipkart vs Amazon Channel Analysis</div>
                    <div id="channelChart" class="chart"></div>
                </div>

                <div class="chart-container pie-chart">
                    <div class="chart-title">üìÖ Sales by Day of Week</div>
                    <div id="dayOfWeekChart" class="chart"></div>
                </div>

                <div class="chart-container line-chart">
                    <div class="chart-title">üìÜ Sales by Month</div>
                    <div id="monthlyPatternChart" class="chart"></div>
                </div>

                <div class="chart-container bar-chart">
                    <div class="chart-title">üìà Year-over-Year Growth</div>
                    <div id="yoyGrowthChart" class="chart"></div>
                </div>

                <div class="chart-container line-chart">
                    <div class="chart-title">üéØ Average Order Value Trends</div>
                    <div id="aovChart" class="chart"></div>
                </div>

                <div class="chart-container bar-chart">
                    <div class="chart-title">üìä Sales Distribution by State</div>
                    <div id="stateDistributionChart" class="chart"></div>
                </div>
            </div>
        </div>

        <!-- Returns Tab -->
        <div id="returns" class="tab-content">
            <!-- Returns upload message removed - using fixed Jan-June 2025 returns data -->
            
            <div class="stats-grid" id="returnsStatsGrid">
                <!-- Returns stats will be populated here -->
            </div>

            <div class="chart-container">
                <div class="chart-title">üîÑ Returns Trend</div>
                <div id="returnsTrendChart" class="chart"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">üì¶ Returns by SKU</div>
                <div id="returnsSkuChart" class="chart"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">üó∫Ô∏è Returns by State</div>
                <div id="returnsStateChart" class="chart"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">‚ö†Ô∏è High-Risk Returns Analysis</div>
                <div id="highRiskReturns" class="chart">
                    <div class="loading">Loading high-risk returns analysis...</div>
                </div>
            </div>
        </div>

        <!-- Predictions Tab -->
        <div id="predictions" class="tab-content">
            <div class="prediction-form">
                <h2>üìä Monthly Sales Predictions for All SKUs</h2>
                <p>This table shows predicted monthly sales quantities for all SKUs based on historical data patterns.</p>
                <button class="btn" onclick="generateMonthlyPredictionTable()">Generate Monthly Predictions</button>
                <div id="monthlyPredictionTableResult"></div>
            </div>

            <div class="prediction-form" style="margin-top: 30px;">
                <h2>üè™ Channel-wise Predictions (Top 20 SKUs)</h2>
                <p>This shows predictions separated by channel (Amazon vs Flipkart) for the top 20 SKUs.</p>
                <button class="btn" onclick="generateChannelWisePredictions()">Generate Channel-wise Predictions</button>
                <div id="channelWisePredictionsResult"></div>
            </div>

            <div class="prediction-form" style="margin-top: 30px;">
                <h2>üó∫Ô∏è State-wise Channel Distribution</h2>
                <p>This shows which states are served by which channels (Amazon vs Flipkart).</p>
                <button class="btn" onclick="generateStateChannelDistribution()">Generate State-wise Analysis</button>
                <div id="stateChannelDistributionResult"></div>
            </div>
        </div>

        <!-- Forecasting Tab -->
        <div id="forecasting" class="tab-content">
            <div class="stats-grid" id="forecastingStatsGrid">
                <!-- Forecasting stats will be populated here -->
            </div>

            <div class="chart-container">
                <div class="chart-title">üîÆ Sales Forecasting Model Performance</div>
                <div id="forecastingAccuracyChart" class="chart"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">üìà Next Month Sales Predictions</div>
                <div id="nextMonthPredictionsChart" class="chart"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">‚ö†Ô∏è Return Risk Predictions</div>
                <div id="returnRiskChart" class="chart"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">üè™ Channel-wise Predictions (Top 20 SKUs)</div>
                <div id="channelWisePredictionsChart" class="chart"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">üìã Detailed Channel-wise Predictions Table</div>
                <div id="channelWisePredictionsTable" style="padding: 20px;">
                    <div class="loading">Loading channel-wise predictions...</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">üìä Model Comparison & Accuracy</div>
                <div id="modelComparisonChart" class="chart"></div>
            </div>

            <div class="prediction-form">
                <h2>üéØ Custom Prediction Tool</h2>
                <div class="form-group">
                    <label for="forecastSku">SKU:</label>
                    <input type="text" id="forecastSku" placeholder="Enter SKU (e.g., CMSM01)">
                </div>
                <div class="form-group">
                    <label for="forecastPeriod">Forecast Period:</label>
                    <select id="forecastPeriod">
                        <option value="1">Next 1 Month</option>
                        <option value="3">Next 3 Months</option>
                        <option value="6">Next 6 Months</option>
                        <option value="12">Next 12 Months</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="forecastType">Forecast Type:</label>
                    <select id="forecastType">
                        <option value="sales">Sales Volume</option>
                        <option value="returns">Return Rate</option>
                        <option value="revenue">Revenue</option>
                        <option value="inventory">Inventory Needs</option>
                    </select>
                </div>
                <button class="btn" onclick="generateCustomForecast()">Generate Forecast</button>
                <div id="customForecastResult"></div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis" class="tab-content">
            <div class="stats-grid" id="analysisStatsGrid">
                <!-- Analysis stats will be populated here -->
            </div>

            <div class="charts-grid">
                <div class="chart-container line-chart">
                    <div class="chart-title">üìä Business Intelligence Summary</div>
                    <div id="analysisContent">
                        <div class="loading">Loading analysis...</div>
                    </div>
                </div>

                <div class="chart-container line-chart">
                    <div class="chart-title">üéØ Key Performance Indicators</div>
                    <div id="kpiChart" class="chart"></div>
                </div>

                <div class="chart-container bar-chart">
                    <div class="chart-title">üìà Revenue vs Returns Analysis</div>
                    <div id="revenueReturnsChart" class="chart"></div>
                </div>

                <div class="chart-container pie-chart">
                    <div class="chart-title">üèÜ Top Performing Categories</div>
                    <div id="categoryPerformanceChart" class="chart"></div>
                </div>

                <div class="chart-container line-chart">
                    <div class="chart-title">üìÖ Seasonal Trends Analysis</div>
                    <div id="seasonalTrendsChart" class="chart"></div>
                </div>

                <div class="chart-container bar-chart">
                    <div class="chart-title">üí∞ Profitability Analysis by SKU</div>
                    <div id="profitabilityChart" class="chart"></div>
                </div>

                <div class="chart-container half-width">
                    <div class="chart-title">üö® Risk Assessment Dashboard</div>
                    <div id="riskAssessmentChart" class="chart"></div>
                </div>

                <div class="chart-container half-width">
                    <div class="chart-title">üìä Top States by Sales Volume</div>
                    <div id="customerBehaviorChart" class="chart"></div>
                </div>

                <div class="chart-container bar-chart">
                    <div class="chart-title">üéØ Top SKUs by Sales Performance</div>
                    <div id="inventoryOptimizationChart" class="chart"></div>
                </div>

                <div class="chart-container bar-chart">
                    <div class="chart-title">üó∫Ô∏è State-wise Channel Distribution</div>
                    <div id="stateChannelDistributionChart" class="chart"></div>
                </div>

                <div class="chart-container line-chart">
                    <div class="chart-title">üìã Actionable Business Recommendations</div>
                    <div id="businessRecommendations">
                        <div class="loading">Loading recommendations...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentData = null;
        let skuList = [];

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'overview') {
                loadOverviewData();
            } else if (tabName === 'returns') {
                loadReturnsData();
            } else if (tabName === 'predictions') {
                loadPredictionData();
            } else if (tabName === 'forecasting') {
                loadForecastingData();
            } else if (tabName === 'analysis') {
                loadAnalysisData();
            }
        }

        // Upload functionality removed - using fixed Jan-June 2025 data

        // File info functions removed - no longer needed

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            document.getElementById('upload').appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Load overview data
        async function loadOverviewData() {
            try {
                const response = await fetch(`${API_BASE}/analysis`);
                const result = await response.json();

                if (response.ok) {
                    displayStats(result.data);
                    loadCharts(result.data);
                    loadChannelAnalysis();
                } else {
                    showMessage(`Error loading data: ${result.detail}`, 'error');
                }
            } catch (error) {
                showMessage(`Failed to load data: ${error.message}`, 'error');
            }
        }

        function displayStats(data) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>${data.overview.total_revenue.toLocaleString()}</h3>
                    <p>Total Revenue (‚Çπ)</p>
                </div>
                <div class="stat-card">
                    <h3>${data.overview.total_quantity.toLocaleString()}</h3>
                    <p>Total Units Sold</p>
                </div>
                <div class="stat-card">
                    <h3>${data.overview.total_skus}</h3>
                    <p>Total SKUs</p>
                </div>
                <div class="stat-card">
                    <h3>${data.sales_performance.daily_average.toFixed(0)}</h3>
                    <p>Daily Average</p>
                </div>
            `;
        }

        async function loadCharts(data) {
            // Load sales trend chart
            const trendResponse = await fetch(`${API_BASE}/charts/sales-trend`);
            const trendData = await trendResponse.json();
            
            if (trendResponse.ok) {
                createSalesTrendChart(trendData.data);
                createDailySalesChart(trendData.data);
            }

            // Load SKU performance chart
            const skuResponse = await fetch(`${API_BASE}/charts/sku-performance`);
            const skuData = await skuResponse.json();
            
            if (skuResponse.ok) {
                createSkuChart(skuData.data);
                createRevenueChart(skuData.data);
            }

            // Load geographic chart
            const geoResponse = await fetch(`${API_BASE}/charts/geographic-distribution`);
            const geoData = await geoResponse.json();
            
            if (geoResponse.ok) {
                createGeoChart(geoData.data);
                createStateDistributionChart(geoData.data);
            }

            // Create additional charts from the analysis data
            createDayOfWeekChart(data);
            createMonthlyPatternChart(data);
            createYoYGrowthChart(data);
            createAOVChart(data);
        }

        function createSalesTrendChart(data) {
            const chart = echarts.init(document.getElementById('salesTrendChart'));
            const option = {
                title: {
                    text: 'Monthly Sales Trend',
                    left: 'center',
                    top: 10,
                    textStyle: {
                        fontSize: 16
                    }
                },
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    type: 'category',
                    data: data.monthly_trend.dates
                },
                yAxis: {
                    type: 'value',
                    name: 'Quantity'
                },
                series: [{
                    data: data.monthly_trend.quantities,
                    type: 'line',
                    smooth: true,
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(52, 152, 219, 0.3)' },
                            { offset: 1, color: 'rgba(52, 152, 219, 0.1)' }
                        ])
                    },
                    lineStyle: {
                        color: '#3498db'
                    }
                }]
            };
            chart.setOption(option);
        }

        function createSkuChart(data) {
            const chart = echarts.init(document.getElementById('skuChart'));
            const option = {
                title: {
                    text: 'Top 10 SKUs by Quantity',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        const dataIndex = params[0].dataIndex;
                        const sku = data.skus[dataIndex];
                        const name = data.sku_names ? data.sku_names[dataIndex] : sku;
                        return `${sku} - ${name}<br/>Quantity: ${params[0].value}`;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: data.sku_displays || data.skus,
                    axisLabel: {
                        rotate: 45,
                        formatter: function(value) {
                            // Show only SKU code for x-axis to avoid overcrowding
                            return value.split(' - ')[0];
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'Quantity'
                },
                series: [{
                    data: data.quantities,
                    type: 'bar',
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#667eea' },
                            { offset: 1, color: '#764ba2' }
                        ])
                    }
                }]
            };
            chart.setOption(option);
        }

        function createGeoChart(data) {
            const chart = echarts.init(document.getElementById('geoChart'));
            const option = {
                title: {
                    text: 'Top 10 States by Revenue',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: ‚Çπ{c} ({d}%)'
                },
                series: [{
                    name: 'Revenue',
                    type: 'pie',
                    radius: '50%',
                    data: data.states.map((state, index) => ({
                        value: data.revenues[index],
                        name: state
                    })),
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            chart.setOption(option);
        }

        function createDailySalesChart(data) {
            const chart = echarts.init(document.getElementById('dailySalesChart'));
            const option = {
                title: {
                    text: 'Daily Sales Pattern (Last 30 Days)',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    type: 'category',
                    data: data.daily_trend.dates
                },
                yAxis: {
                    type: 'value',
                    name: 'Sales Quantity'
                },
                series: [{
                    data: data.daily_trend.quantities,
                    type: 'bar',
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#2ecc71' },
                            { offset: 1, color: '#27ae60' }
                        ])
                    }
                }]
            };
            chart.setOption(option);
        }

        function createRevenueChart(data) {
            const chart = echarts.init(document.getElementById('revenueChart'));
            const option = {
                title: {
                    text: 'Top 10 SKUs by Revenue',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        const dataIndex = params[0].dataIndex;
                        const sku = data.skus[dataIndex];
                        const name = data.sku_names ? data.sku_names[dataIndex] : sku;
                        return `${sku} - ${name}<br/>Revenue: ‚Çπ${params[0].value.toLocaleString()}`;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: data.sku_displays || data.skus,
                    axisLabel: {
                        rotate: 45,
                        formatter: function(value) {
                            return value.split(' - ')[0];
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'Revenue (‚Çπ)'
                },
                series: [{
                    data: data.quantities.map(qty => qty * 100), // Mock revenue calculation
                    type: 'bar',
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#f39c12' },
                            { offset: 1, color: '#e67e22' }
                        ])
                    }
                }]
            };
            chart.setOption(option);
        }

        function createDayOfWeekChart(data) {
            const chart = echarts.init(document.getElementById('dayOfWeekChart'));
            const dowNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const bestDay = data.temporal_patterns.best_day;
            const worstDay = data.temporal_patterns.worst_day;
            
            // Mock data for day of week
            const dowData = dowNames.map((day, index) => ({
                value: index === bestDay ? 100 : index === worstDay ? 20 : Math.random() * 80 + 20,
                name: day
            }));
            
            const option = {
                title: {
                    text: 'Sales Performance by Day of Week',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c}%'
                },
                series: [{
                    name: 'Sales Performance',
                    type: 'pie',
                    radius: '50%',
                    data: dowData,
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            chart.setOption(option);
        }

        async function loadChannelAnalysis() {
            try {
                const response = await fetch(`${API_BASE}/channel-analysis`);
                const result = await response.json();

                if (response.ok) {
                    createChannelChart(result.data);
                }
            } catch (error) {
                console.error('Failed to load channel analysis:', error);
            }
        }

        function createChannelChart(data) {
            const chart = echarts.init(document.getElementById('channelChart'));
            
            // Use recent trends data for monthly analysis
            const recentTrends = data.recent_trends;
            const months = Object.keys(recentTrends).sort();
            
            const amazonRevenue = months.map(month => recentTrends[month].amazon_revenue || 0);
            const flipkartRevenue = months.map(month => recentTrends[month].flipkart_revenue || 0);
            
            const option = {
                title: {
                    text: 'Monthly Channel Revenue Trends (2024-2025)',
                    left: 'center',
                    top: 10,
                    textStyle: {
                        fontSize: 16
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        let result = params[0].axisValue + '<br/>';
                        params.forEach(param => {
                            result += param.marker + param.seriesName + ': ‚Çπ' + (param.value / 1000000).toFixed(1) + 'M<br/>';
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['Amazon', 'Flipkart'],
                    top: 50
                },
                xAxis: {
                    type: 'category',
                    data: months.map(month => {
                        const [year, monthNum] = month.split('-');
                        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        return monthNames[parseInt(monthNum) - 1] + ' ' + year;
                    }),
                    axisLabel: {
                        interval: 0,
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'Revenue (‚Çπ)',
                    axisLabel: {
                        formatter: function(value) {
                            return (value / 1000000).toFixed(0) + 'M';
                        }
                    }
                },
                series: [
                    {
                        name: 'Amazon',
                        type: 'line',
                        data: amazonRevenue,
                        itemStyle: {
                            color: '#ff9900'
                        },
                        lineStyle: {
                            width: 3
                        },
                        smooth: true
                    },
                    {
                        name: 'Flipkart',
                        type: 'line',
                        data: flipkartRevenue,
                        itemStyle: {
                            color: '#2874f0'
                        },
                        lineStyle: {
                            width: 3
                        },
                        smooth: true
                    }
                ]
            };
            chart.setOption(option);
        }

        function createMonthlyPatternChart(data) {
            const chart = echarts.init(document.getElementById('monthlyPatternChart'));
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const bestMonth = data.temporal_patterns.best_month;
            const worstMonth = data.temporal_patterns.worst_month;
            
            // Mock monthly data
            const monthlyData = months.map((month, index) => ({
                value: index + 1 === bestMonth ? 100 : index + 1 === worstMonth ? 20 : Math.random() * 80 + 20,
                name: month
            }));
            
            const option = {
                title: {
                    text: 'Sales Performance by Month',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    type: 'category',
                    data: months
                },
                yAxis: {
                    type: 'value',
                    name: 'Performance Index'
                },
                series: [{
                    data: monthlyData.map(item => item.value),
                    type: 'line',
                    smooth: true,
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(52, 152, 219, 0.3)' },
                            { offset: 1, color: 'rgba(52, 152, 219, 0.1)' }
                        ])
                    },
                    lineStyle: {
                        color: '#3498db'
                    }
                }]
            };
            chart.setOption(option);
        }

        function createYoYGrowthChart(data) {
            const chart = echarts.init(document.getElementById('yoyGrowthChart'));
            const years = ['2018', '2019', '2020', '2021', '2022', '2023', '2024', '2025'];
            const growthData = years.map((year, index) => ({
                value: index === 0 ? 0 : Math.random() * 50 - 10, // Random growth between -10% and 40%
                name: year
            }));
            
            const option = {
                title: {
                    text: 'Year-over-Year Growth Rate',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: '{b}: {c}%'
                },
                xAxis: {
                    type: 'category',
                    data: years
                },
                yAxis: {
                    type: 'value',
                    name: 'Growth Rate (%)',
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                series: [{
                    data: growthData.map(item => item.value),
                    type: 'bar',
                    itemStyle: {
                        color: function(params) {
                            return params.value >= 0 ? '#27ae60' : '#e74c3c';
                        }
                    }
                }]
            };
            chart.setOption(option);
        }

        function createAOVChart(data) {
            const chart = echarts.init(document.getElementById('aovChart'));
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const aovData = months.map(() => Math.random() * 200 + 800); // Mock AOV between 800-1000
            
            const option = {
                title: {
                    text: 'Average Order Value Trends',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: '{b}: ‚Çπ{c}'
                },
                xAxis: {
                    type: 'category',
                    data: months
                },
                yAxis: {
                    type: 'value',
                    name: 'AOV (‚Çπ)',
                    axisLabel: {
                        formatter: '‚Çπ{value}'
                    }
                },
                series: [{
                    data: aovData,
                    type: 'line',
                    smooth: true,
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(155, 89, 182, 0.3)' },
                            { offset: 1, color: 'rgba(155, 89, 182, 0.1)' }
                        ])
                    },
                    lineStyle: {
                        color: '#9b59b6'
                    }
                }]
            };
            chart.setOption(option);
        }

        function createStateDistributionChart(data) {
            const chart = echarts.init(document.getElementById('stateDistributionChart'));
            const option = {
                title: {
                    text: 'Sales Distribution by State',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                xAxis: {
                    type: 'category',
                    data: data.states,
                    axisLabel: {
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'Revenue (‚Çπ)'
                },
                series: [{
                    data: data.revenues,
                    type: 'bar',
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#e67e22' },
                            { offset: 1, color: '#d35400' }
                        ])
                    }
                }]
            };
            chart.setOption(option);
        }

        // Prediction functionality
        async function makePrediction() {
            const sku = document.getElementById('predSku').value;
            const predType = document.getElementById('predType').value;
            const date = document.getElementById('predDate').value;

            if (!sku) {
                showMessage('Please enter a SKU', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/predict`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sku: sku,
                        prediction_type: predType,
                        date: date
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    const resultDiv = document.getElementById('predictionResult');
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>üîÆ Prediction Result</h3>
                            <p><strong>SKU:</strong> ${result.sku}</p>
                            <p><strong>Predicted Quantity:</strong> ${result.predicted_quantity.toFixed(0)} units</p>
                            <p><strong>Confidence:</strong> ${result.confidence}</p>
                            <p><strong>Timestamp:</strong> ${new Date(result.timestamp).toLocaleString()}</p>
                        </div>
                    `;
                } else {
                    showMessage(`Prediction failed: ${result.detail}`, 'error');
                }
            } catch (error) {
                showMessage(`Prediction error: ${error.message}`, 'error');
            }
        }

        // Generate prediction table for all SKUs
        async function generatePredictionTable() {
            const predType = document.getElementById('tablePredType').value;
            const resultDiv = document.getElementById('predictionTableResult');
            
            if (!predType) {
                showMessage('Please select prediction type', 'error');
                return;
            }

            resultDiv.innerHTML = '<div class="loading">Generating predictions for all SKUs...</div>';

            try {
                // Get top 20 SKUs for the table
                const topSkus = skuList.slice(0, 20);
                const predictions = [];

                for (const sku of topSkus) {
                    try {
                        const response = await fetch(`${API_BASE}/predict`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                sku: sku.sku,
                                prediction_type: predType,
                                date: new Date().toISOString().split('T')[0]
                            })
                        });

                        const result = await response.json();
                        if (response.ok) {
                            predictions.push({
                                sku: sku.sku,
                                name: sku.name,
                                prediction: result.predicted_quantity,
                                confidence: result.confidence
                            });
                        }
                    } catch (error) {
                        console.error(`Failed to predict for ${sku.sku}:`, error);
                    }
                }

                // Display results in a table
                if (predictions.length > 0) {
                    const tableHTML = `
                        <div class="success" style="background: #ffffff !important;">
                            <h3>Prediction Results for Top ${predictions.length} SKUs</h3>
                            <div style="overflow-x: auto; margin-top: 1rem;">
                                <table style="width: 100%; border-collapse: collapse; border: 1px solid #e5e7eb;">
                                    <thead>
                                        <tr style="background: #f9fafb;">
                                            <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: left;">SKU</th>
                                            <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: left;">Product Name</th>
                                            <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: left;">Predicted ${predType === 'daily' ? 'Daily' : 'Monthly'} Sales</th>
                                            <th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: left;">Confidence</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${predictions.map(p => `
                                            <tr>
                                                <td style="padding: 0.75rem; border: 1px solid #e5e7eb;">${p.sku}</td>
                                                <td style="padding: 0.75rem; border: 1px solid #e5e7eb;">${p.name}</td>
                                                <td style="padding: 0.75rem; border: 1px solid #e5e7eb; font-weight: 600;">${p.prediction.toFixed(0)}</td>
                                                <td style="padding: 0.75rem; border: 1px solid #e5e7eb;">${p.confidence}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    resultDiv.innerHTML = tableHTML;
                } else {
                    resultDiv.innerHTML = '<div class="error">No predictions could be generated</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Failed to generate prediction table: ${error.message}</div>`;
            }
        }

        async function generateMonthlyPredictionTable() {
            const resultDiv = document.getElementById('monthlyPredictionTableResult');
            
            resultDiv.innerHTML = '<div class="loading">Generating monthly predictions for all SKUs...</div>';

            try {
                // Ensure SKU list is loaded
                if (skuList.length === 0) {
                    await loadSkuData();
                }
                
                // Use ALL SKUs from the dataset
                const allSkus = skuList;
                const predictions = [];
                const batchSize = 20; // Process in batches to avoid overwhelming the API
                let processedCount = 0;
                
                console.log(`Generating predictions for ${allSkus.length} SKUs in batches of ${batchSize}`);

                // Process SKUs in batches
                for (let i = 0; i < allSkus.length; i += batchSize) {
                    const batch = allSkus.slice(i, i + batchSize);
                    console.log(`Processing batch ${Math.floor(i/batchSize) + 1}/${Math.ceil(allSkus.length/batchSize)}: SKUs ${i+1}-${Math.min(i+batchSize, allSkus.length)}`);
                    
                    // Update progress
                    resultDiv.innerHTML = `<div class="loading">Processing SKUs ${i+1}-${Math.min(i+batchSize, allSkus.length)} of ${allSkus.length}...</div>`;
                    
                    // Process batch in parallel
                    const batchPromises = batch.map(async (sku) => {
                        try {
                            console.log(`Predicting for SKU: ${sku.sku}`);
                            const response = await fetch(`${API_BASE}/predict`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    sku: sku.sku,
                                    prediction_type: 'monthly',
                                    date: new Date().toISOString().split('T')[0]
                                })
                            });

                            const result = await response.json();
                            if (response.ok) {
                                console.log(`‚úÖ ${sku.sku}: ${result.predicted_quantity} (${result.status})`);
                                return {
                                    sku: sku.sku,
                                    name: sku.name,
                                    prediction: result.predicted_quantity,
                                    confidence: result.confidence,
                                    status: result.status
                                };
                            } else {
                                console.error(`‚ùå ${sku.sku}: API error`, result);
                                return null;
                            }
                        } catch (error) {
                            console.error(`‚ùå Failed to predict for ${sku.sku}:`, error);
                            return null;
                        }
                    });
                    
                    // Wait for batch to complete
                    const batchResults = await Promise.all(batchPromises);
                    
                    // Add successful predictions to the main array
                    batchResults.forEach(result => {
                        if (result) {
                            predictions.push(result);
                        }
                    });
                    
                    processedCount += batch.length;
                    console.log(`Completed batch: ${processedCount}/${allSkus.length} SKUs processed`);
                }

                // Sort predictions: active SKUs by predicted quantity (descending), then discontinued SKUs
                predictions.sort((a, b) => {
                    // If both are discontinued or both are active, sort by prediction
                    if (a.status === b.status) {
                        return b.prediction - a.prediction;
                    }
                    // Active SKUs come first
                    if (a.status === 'active' && b.status === 'discontinued') {
                        return -1;
                    }
                    if (a.status === 'discontinued' && b.status === 'active') {
                        return 1;
                    }
                    return 0;
                });

                // Display results in a table
                if (predictions.length > 0) {
                    // Since we have data up to June 2025, predict for July 2025
                    const monthName = 'July 2025';
                    
                    // Count active vs discontinued SKUs
                    const activeCount = predictions.filter(p => p.status === 'active').length;
                    const discontinuedCount = predictions.filter(p => p.status === 'discontinued').length;
                    
                    const tableHTML = `
                        <div class="success" style="background: #ffffff !important;">
                            <h3>Monthly Sales Predictions for ${monthName}</h3>
                            <p style="color: #6b7280; margin-bottom: 1rem;">
                                Predictions for top ${predictions.length} SKUs: 
                                <span style="color: #059669; font-weight: 600;">${activeCount} active</span> | 
                                <span style="color: #6b7280; font-weight: 600;">${discontinuedCount} discontinued</span>
                            </p>
                            <div style="overflow-x: auto; margin-top: 1rem; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem; background: white;">
                                    <thead>
                                        <tr style="background: #1e3a8a; color: white;">
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 2px solid #1e40af;">Rank</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 2px solid #1e40af;">SKU</th>
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 2px solid #1e40af;">Product Name</th>
                                            <th style="padding: 1rem; text-align: right; font-weight: 600; border-bottom: 2px solid #1e40af;">Predicted Monthly Sales</th>
                                            <th style="padding: 1rem; text-align: center; font-weight: 600; border-bottom: 2px solid #1e40af;">Confidence</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${predictions.map((p, index) => {
                                            const isDiscontinued = p.status === 'discontinued';
                                            const opacity = isDiscontinued ? '0.6' : '1';
                                            const bgColor = index % 2 === 0 ? '#ffffff' : '#f8fafc';
                                            const textColor = isDiscontinued ? '#9ca3af' : '#1e293b';
                                            const skuColor = isDiscontinued ? '#9ca3af' : '#1e293b';
                                            const nameColor = isDiscontinued ? '#9ca3af' : '#475569';
                                            const predictionColor = isDiscontinued ? '#6b7280' : '#059669';
                                            
                                            return `
                                            <tr style="background: ${bgColor}; border-bottom: 1px solid #e2e8f0; opacity: ${opacity};">
                                                <td style="padding: 1rem; text-align: center; font-weight: 600; color: #64748b;">${index + 1}</td>
                                                <td style="padding: 1rem; font-weight: 500; color: ${skuColor};">${p.sku}</td>
                                                <td style="padding: 1rem; color: ${nameColor};">${p.name}${isDiscontinued ? ' <span style="color: #ef4444; font-size: 0.75rem;">(DISCONTINUED)</span>' : ''}</td>
                                                <td style="padding: 1rem; text-align: right; font-weight: 600; color: ${predictionColor}; font-size: 1rem;">${Math.round(p.prediction)}</td>
                                                <td style="padding: 1rem; text-align: center;">
                                                    <span style="padding: 0.375rem 0.75rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600; 
                                                        background-color: ${p.confidence === 'high' ? '#dcfce7' : p.confidence === 'medium' ? '#fef3c7' : p.confidence === 'discontinued' ? '#f3f4f6' : '#fee2e2'};
                                                        color: ${p.confidence === 'high' ? '#166534' : p.confidence === 'medium' ? '#92400e' : p.confidence === 'discontinued' ? '#6b7280' : '#991b1b'};
                                                        border: 1px solid ${p.confidence === 'high' ? '#bbf7d0' : p.confidence === 'medium' ? '#fde68a' : p.confidence === 'discontinued' ? '#d1d5db' : '#fecaca'};">
                                                        ${p.confidence === 'discontinued' ? 'DISCONTINUED' : p.confidence.toUpperCase()}
                                                    </span>
                                                </td>
                                            </tr>
                                        `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    resultDiv.innerHTML = tableHTML;
                } else {
                    resultDiv.innerHTML = '<div class="error">No predictions could be generated</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Failed to generate prediction table: ${error.message}</div>`;
            }
        }

        async function generateChannelWisePredictions() {
            const resultDiv = document.getElementById('channelWisePredictionsResult');
            resultDiv.innerHTML = '<div class="loading">Generating channel-wise predictions...</div>';

            try {
                const response = await fetch(`${API_BASE}/predictions/channel-wise`);
                const data = await response.json();

                if (response.ok && data.data.predictions) {
                    let tableHtml = `
                        <div style="margin-top: 20px;">
                            <h3>üè™ Channel-wise Predictions (Top 20 SKUs)</h3>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                    <thead>
                                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                            <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">SKU</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Total Predicted</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Amazon<br/>Predicted</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Flipkart<br/>Predicted</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Amazon<br/>Confidence</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Flipkart<br/>Confidence</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    data.data.predictions.forEach(sku => {
                        const amazonData = sku.channels['Amazon Stores'];
                        const flipkartData = sku.channels['Flipkart Store'];

                        const statusColor = sku.status === 'active' ? '#28a745' : '#6c757d';
                        const statusText = sku.status === 'active' ? 'Active' : 'Inactive';

                        tableHtml += `
                            <tr style="border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: bold;">${sku.sku}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${sku.total_predicted_quantity}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${amazonData.predicted_quantity}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${flipkartData.predicted_quantity}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">
                                    <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; 
                                        background: ${amazonData.confidence === 'high' ? '#d4edda' : amazonData.confidence === 'medium' ? '#fff3cd' : '#f8d7da'};
                                        color: ${amazonData.confidence === 'high' ? '#155724' : amazonData.confidence === 'medium' ? '#856404' : '#721c24'};">
                                        ${amazonData.confidence}
                                    </span>
                                </td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">
                                    <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; 
                                        background: ${flipkartData.confidence === 'high' ? '#d4edda' : flipkartData.confidence === 'medium' ? '#fff3cd' : '#f8d7da'};
                                        color: ${flipkartData.confidence === 'high' ? '#155724' : flipkartData.confidence === 'medium' ? '#856404' : '#721c24'};">
                                        ${flipkartData.confidence}
                                    </span>
                                </td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">
                                    <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span>
                                </td>
                            </tr>
                        `;
                    });

                    tableHtml += `
                                    </tbody>
                                </table>
                            </div>
                            <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <h4 style="margin: 0 0 10px 0; color: #2c3e50;">üìä Summary</h4>
                                <p style="margin: 5px 0;"><strong>Total SKUs:</strong> ${data.data.summary.total_skus}</p>
                                <p style="margin: 5px 0;"><strong>Active SKUs:</strong> ${data.data.summary.active_skus}</p>
                                <p style="margin: 5px 0;"><strong>Total Predicted Quantity:</strong> ${data.data.summary.total_predicted_quantity.toLocaleString()} units</p>
                            </div>
                        </div>
                    `;

                    resultDiv.innerHTML = tableHtml;
                } else {
                    resultDiv.innerHTML = '<div class="error">Failed to load channel-wise predictions data</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error loading channel-wise predictions: ${error.message}</div>`;
            }
        }

        async function generateStateChannelDistribution() {
            const resultDiv = document.getElementById('stateChannelDistributionResult');
            resultDiv.innerHTML = '<div class="loading">Generating state-wise channel distribution...</div>';

            try {
                const response = await fetch(`${API_BASE}/analysis/state-channel-distribution`);
                const data = await response.json();

                if (response.ok && data.data.state_distribution) {
                    let tableHtml = `
                        <div style="margin-top: 20px;">
                            <h3>üó∫Ô∏è State-wise Channel Distribution</h3>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                    <thead>
                                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                            <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">State</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Total Quantity</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Amazon<br/>Quantity</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Flipkart<br/>Quantity</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Amazon<br/>%</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Flipkart<br/>%</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Primary<br/>Channel</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    data.data.state_distribution.forEach(state => {
                        const primaryChannelColor = state.primary_channel === 'Amazon' ? '#ff9900' : 
                                                   state.primary_channel === 'Flipkart' ? '#2874f0' : '#6c757d';

                        tableHtml += `
                            <tr style="border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: bold;">${state.state}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${state.total_quantity.toLocaleString()}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${state.amazon_quantity.toLocaleString()}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${state.flipkart_quantity.toLocaleString()}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${state.amazon_percentage}%</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${state.flipkart_percentage}%</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">
                                    <span style="color: ${primaryChannelColor}; font-weight: bold;">${state.primary_channel}</span>
                                </td>
                            </tr>
                        `;
                    });

                    tableHtml += `
                                    </tbody>
                                </table>
                            </div>
                            <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <h4 style="margin: 0 0 10px 0; color: #2c3e50;">üìä Summary</h4>
                                <p style="margin: 5px 0;"><strong>Total States:</strong> ${data.data.summary.total_states}</p>
                                <p style="margin: 5px 0;"><strong>Amazon Dominant States:</strong> ${data.data.summary.amazon_dominant_states}</p>
                                <p style="margin: 5px 0;"><strong>Flipkart Dominant States:</strong> ${data.data.summary.flipkart_dominant_states}</p>
                                <p style="margin: 5px 0;"><strong>Equal States:</strong> ${data.data.summary.equal_states}</p>
                            </div>
                        </div>
                    `;

                    resultDiv.innerHTML = tableHtml;
                } else {
                    resultDiv.innerHTML = '<div class="error">Failed to load state-channel distribution data</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error loading state-channel distribution: ${error.message}</div>`;
            }
        }

        async function loadPredictionData() {
            try {
                const response = await fetch(`${API_BASE}/predictions/monthly`);
                const result = await response.json();

                if (response.ok) {
                    createPredictionChart(result.data);
                }
            } catch (error) {
                console.error('Failed to load prediction data:', error);
            }
        }

        function createPredictionChart(data) {
            const chartElement = document.getElementById('predictionChart');
            if (!chartElement) {
                console.log('Prediction chart element not found, skipping chart creation');
                return;
            }
            const chart = echarts.init(chartElement);
            const option = {
                title: {
                    text: 'Monthly Prediction Accuracy',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    type: 'category',
                    data: data.predictions.map(p => p.sku)
                },
                yAxis: {
                    type: 'value',
                    name: 'MAE (Mean Absolute Error)'
                },
                series: [{
                    data: data.predictions.map(p => p.mae),
                    type: 'bar',
                    itemStyle: {
                        color: '#e74c3c'
                    }
                }]
            };
            chart.setOption(option);
        }

        // Returns functionality
        async function loadReturnsData() {
            try {
                // Load returns overview
                const overviewResponse = await fetch(`${API_BASE}/returns/overview`);
                const overviewData = await overviewResponse.json();
                
                if (overviewResponse.ok && overviewData.data) {
                    console.log('Returns overview data:', overviewData.data);
                    displayReturnsStats(overviewData.data);
                } else {
                    console.log('No returns data available:', overviewData.detail);
                    // Show error message in stats grid
                    const statsGrid = document.getElementById('returnsStatsGrid');
                    statsGrid.innerHTML = `
                        <div class="stat-card">
                            <h3>No Data</h3>
                            <p>Returns data not available</p>
                        </div>
                    `;
                }

                // Load returns charts
                await loadReturnsCharts();

                // Load high-risk returns
                const highRiskResponse = await fetch(`${API_BASE}/returns/high-risk`);
                const highRiskData = await highRiskResponse.json();
                
                if (highRiskResponse.ok) {
                    displayHighRiskReturns(highRiskData.data);
                }

            } catch (error) {
                console.error('Failed to load returns data:', error);
            }
        }

        function displayReturnsStats(data) {
            const statsGrid = document.getElementById('returnsStatsGrid');
            
            // Calculate return rate (returns vs total sales)
            const returnRate = data.total_return_amount && data.total_return_amount > 0 ? 
                ((data.total_return_amount / 56415965.94) * 100) : 0; // Using known total sales revenue
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>${returnRate.toFixed(1)}%</h3>
                    <p>Overall Return Rate</p>
                </div>
                <div class="stat-card">
                    <h3>‚Çπ${(data.total_return_amount || 0).toLocaleString()}</h3>
                    <p>Total Return Amount</p>
                </div>
                <div class="stat-card">
                    <h3>${(data.total_returns || 0).toLocaleString()}</h3>
                    <p>Total Returns</p>
                </div>
                <div class="stat-card">
                    <h3>‚Çπ${(data.avg_return_amount || 0).toLocaleString()}</h3>
                    <p>Avg Return Amount</p>
                </div>
            `;
        }

        async function loadReturnsCharts() {
            console.log('Loading returns charts...');
            
            try {
                // Load returns trend chart
                console.log('Loading returns trend chart...');
                const trendResponse = await fetch(`${API_BASE}/charts/returns-trend`);
                const trendData = await trendResponse.json();
                
                if (trendResponse.ok) {
                    console.log('Returns trend data:', trendData);
                    createReturnsTrendChart(trendData.data);
                } else {
                    console.error('Failed to load returns trend:', trendData);
                }

                // Load returns by SKU chart
                console.log('Loading returns by SKU chart...');
                const skuResponse = await fetch(`${API_BASE}/charts/returns-by-sku`);
                const skuData = await skuResponse.json();
                
                if (skuResponse.ok) {
                    console.log('Returns SKU data:', skuData);
                    createReturnsSkuChart(skuData.data);
                } else {
                    console.error('Failed to load returns SKU:', skuData);
                }

                // Load returns by state chart
                console.log('Loading returns by state chart...');
                const stateResponse = await fetch(`${API_BASE}/charts/returns-by-state`);
                const stateData = await stateResponse.json();
                
                if (stateResponse.ok) {
                    console.log('Returns state data:', stateData);
                    createReturnsStateChart(stateData.data);
                } else {
                    console.error('Failed to load returns state:', stateData);
                }
            } catch (error) {
                console.error('Error loading returns charts:', error);
            }
        }

        function createReturnsTrendChart(data) {
            const chart = echarts.init(document.getElementById('returnsTrendChart'));
            const option = {
                title: {
                    text: 'Monthly Returns Trend',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    type: 'category',
                    data: data.monthly_trend.dates
                },
                yAxis: {
                    type: 'value',
                    name: 'Returns Quantity'
                },
                series: [{
                    data: data.monthly_trend.quantities,
                    type: 'line',
                    smooth: true,
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(231, 76, 60, 0.3)' },
                            { offset: 1, color: 'rgba(231, 76, 60, 0.1)' }
                        ])
                    },
                    lineStyle: {
                        color: '#e74c3c'
                    }
                }]
            };
            chart.setOption(option);
        }

        function createReturnsSkuChart(data) {
            const chart = echarts.init(document.getElementById('returnsSkuChart'));
            const option = {
                title: {
                    text: 'Top 10 SKUs by Returns',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                xAxis: {
                    type: 'category',
                    data: data.skus,
                    axisLabel: {
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'Returns Quantity'
                },
                series: [{
                    data: data.quantities,
                    type: 'bar',
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#e74c3c' },
                            { offset: 1, color: '#c0392b' }
                        ])
                    }
                }]
            };
            chart.setOption(option);
        }

        function createReturnsStateChart(data) {
            const chart = echarts.init(document.getElementById('returnsStateChart'));
            const option = {
                title: {
                    text: 'Top 10 States by Returns',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} returns ({d}%)'
                },
                series: [{
                    name: 'Returns',
                    type: 'pie',
                    radius: '50%',
                    data: data.states.map((state, index) => ({
                        value: data.quantities[index],
                        name: state
                    })),
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            chart.setOption(option);
        }

        function displayHighRiskReturns(data) {
            const highRiskDiv = document.getElementById('highRiskReturns');
            if (!highRiskDiv) return;
            
            highRiskDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>üö® High-Risk SKUs</h3>
                        ${data.high_risk_skus.slice(0, 10).map(sku => 
                            `<p><strong>${sku.sku}:</strong> ${sku.return_quantity} returns (${sku.risk_level} risk)</p>`
                        ).join('')}
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>üìä Risk Summary</h3>
                        <p><strong>Total High-Risk SKUs:</strong> ${data.high_risk_skus.length}</p>
                        <p><strong>Total High-Risk Returns:</strong> ${data.high_risk_skus.reduce((sum, sku) => sum + sku.return_quantity, 0).toLocaleString()}</p>
                        <p><strong>Risk Level:</strong> All marked as "high" risk</p>
                    </div>
                </div>
            `;
        }

        // Forecasting functionality
        async function loadForecastingData() {
            try {
                // Load forecasting stats
                await loadForecastingStats();
                
                // Load forecasting charts
                await loadForecastingCharts();
                
            } catch (error) {
                showMessage(`Failed to load forecasting data: ${error.message}`, 'error');
            }
        }

        async function loadForecastingStats() {
            try {
                // Get model performance data
                const performanceResponse = await fetch(`${API_BASE}/forecasting/model-performance`);
                const performanceData = await performanceResponse.json();
                
                if (performanceResponse.ok) {
                    displayForecastingStats(performanceData.data);
                }

                // Get returns overview for return risk stats
                const returnsResponse = await fetch(`${API_BASE}/returns/overview`);
                const returnsData = await returnsResponse.json();
                
                if (returnsResponse.ok) {
                    updateForecastingStatsWithReturns(returnsData.data);
                }

            } catch (error) {
                console.error('Failed to load forecasting stats:', error);
            }
        }

        function displayForecastingStats(data) {
            const statsGrid = document.getElementById('forecastingStatsGrid');
            
            // Get best model performance
            const bestModel = data.models.find(m => m.name === data.best_model) || data.models[0];
            const overallAccuracy = data.overall_accuracy || 0;
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>${bestModel.mae.toFixed(1)}</h3>
                    <p>Best Model MAE</p>
                </div>
                <div class="stat-card">
                    <h3>${bestModel.mape.toFixed(1)}%</h3>
                    <p>Best Model MAPE</p>
                </div>
                <div class="stat-card">
                    <h3>${data.models.length}</h3>
                    <p>Models Trained</p>
                </div>
                <div class="stat-card">
                    <h3>${bestModel.accuracy_level}</h3>
                    <p>Accuracy Level</p>
                </div>
            `;
        }

        function updateForecastingStatsWithReturns(returnsData) {
            const statsGrid = document.getElementById('forecastingStatsGrid');
            const existingStats = statsGrid.innerHTML;
            
            // Calculate return rate from available data
            const returnRate = returnsData.total_return_amount && returnsData.total_return_amount > 0 ? 
                ((returnsData.total_return_amount / 56415965.94) * 100) : 0;
            
            // Add return risk stats
            const returnRiskLevel = returnRate > 30 ? 'High' : 
                                  returnRate > 15 ? 'Medium' : 'Low';
            
            statsGrid.innerHTML = existingStats + `
                <div class="stat-card">
                    <h3>${returnRiskLevel}</h3>
                    <p>Return Risk Level</p>
                </div>
                <div class="stat-card">
                    <h3>${returnRate.toFixed(1)}%</h3>
                    <p>Current Return Rate</p>
                </div>
            `;
        }

        async function loadForecastingCharts() {
            console.log('Loading forecasting charts...');
            
            try {
                // Load forecasting accuracy chart
                await createForecastingAccuracyChart();
                
                // Load next month predictions chart
                await createNextMonthPredictionsChart();
                
                // Load return risk chart
                await createReturnRiskChart();
                
                // Load channel-wise predictions chart
                await createChannelWisePredictionsChart();
                
                // Load channel-wise predictions table
                await loadChannelWisePredictionsTable();
                
                // Load model comparison chart
                await createModelComparisonChart();
            } catch (error) {
                console.error('Error loading forecasting charts:', error);
            }
        }

        async function createForecastingAccuracyChart() {
            try {
                const response = await fetch(`${API_BASE}/predictions/monthly`);
                const data = await response.json();
                
                if (response.ok && data.data.predictions) {
                    const chart = echarts.init(document.getElementById('forecastingAccuracyChart'));
                    const option = {
                        title: {
                            text: 'Top SKUs by Predicted Sales',
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            }
                        },
                        xAxis: {
                            type: 'category',
                            data: data.data.predictions.map(p => p.sku),
                            axisLabel: {
                                rotate: 45
                            }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'Predicted Quantity'
                        },
                        series: [
                            {
                                name: 'Predicted Sales',
                                type: 'bar',
                                data: data.data.predictions.map(p => p.predicted_quantity),
                                itemStyle: {
                                    color: '#3498db'
                                }
                            }
                        ]
                    };
                    chart.setOption(option);
                }
            } catch (error) {
                console.error('Failed to create forecasting accuracy chart:', error);
            }
        }

        async function createNextMonthPredictionsChart() {
            try {
                const response = await fetch(`${API_BASE}/predictions/monthly`);
                const data = await response.json();
                
                if (response.ok && data.data.predictions) {
                    const chart = echarts.init(document.getElementById('nextMonthPredictionsChart'));
                    const option = {
                        title: {
                            text: 'Next Month Sales Predictions',
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: '{a} <br/>{b}: {c} units ({d}%)'
                        },
                        series: [{
                            name: 'Predicted Sales',
                            type: 'pie',
                            radius: '50%',
                            data: data.data.predictions.map(p => ({
                                value: p.predicted_quantity,
                                name: p.sku
                            })),
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }]
                    };
                    chart.setOption(option);
                }
            } catch (error) {
                console.error('Failed to create next month predictions chart:', error);
            }
        }

        async function createReturnRiskChart() {
            try {
                const response = await fetch(`${API_BASE}/returns/sku-analysis`);
                const data = await response.json();
                
                if (response.ok && data.data.top_returning_skus) {
                    const chart = echarts.init(document.getElementById('returnRiskChart'));
                    
                    // Get top 10 high-risk SKUs
                    const highRiskSkus = data.data.top_returning_skus.slice(0, 10);
                    
                    const option = {
                        title: {
                            text: 'High-Risk SKUs by Return Quantity',
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            }
                        },
                        xAxis: {
                            type: 'category',
                            data: highRiskSkus.map(sku => sku.sku),
                            axisLabel: {
                                rotate: 45
                            }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'Return Quantity'
                        },
                        series: [{
                            name: 'Return Quantity',
                            data: highRiskSkus.map(sku => sku.return_quantity),
                            type: 'bar',
                            itemStyle: {
                                color: '#e74c3c'
                            }
                        }]
                    };
                    chart.setOption(option);
                }
            } catch (error) {
                console.error('Failed to create return risk chart:', error);
            }
        }

        async function createChannelWisePredictionsChart() {
            try {
                const response = await fetch(`${API_BASE}/predictions/channel-wise`);
                const data = await response.json();
                
                if (response.ok && data.data.predictions) {
                    const chart = echarts.init(document.getElementById('channelWisePredictionsChart'));
                    
                    // Get top 10 SKUs for better visualization
                    const topSkus = data.data.predictions.slice(0, 10);
                    
                    // Prepare data for grouped bar chart
                    const amazonData = [];
                    const flipkartData = [];
                    const skuNames = [];
                    
                    topSkus.forEach(sku => {
                        skuNames.push(sku.sku);
                        amazonData.push(sku.channels['Amazon Stores']?.predicted_quantity || 0);
                        flipkartData.push(sku.channels['Flipkart Store']?.predicted_quantity || 0);
                    });
                    
                    const option = {
                        title: {
                            text: 'Channel-wise Predictions (Top 10 SKUs)',
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            },
                            formatter: function(params) {
                                let result = params[0].name + '<br/>';
                                params.forEach(param => {
                                    result += `${param.seriesName}: ${param.value} units<br/>`;
                                });
                                return result;
                            }
                        },
                        legend: {
                            data: ['Amazon Stores', 'Flipkart Store'],
                            top: 30
                        },
                        xAxis: {
                            type: 'category',
                            data: skuNames,
                            axisLabel: {
                                rotate: 45
                            }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'Predicted Quantity'
                        },
                        series: [
                            {
                                name: 'Amazon Stores',
                                type: 'bar',
                                data: amazonData,
                                itemStyle: { color: '#ff9900' }
                            },
                            {
                                name: 'Flipkart Store',
                                type: 'bar',
                                data: flipkartData,
                                itemStyle: { color: '#2874f0' }
                            }
                        ]
                    };
                    chart.setOption(option);
                } else {
                    // Fallback message if API fails
                    const chart = echarts.init(document.getElementById('channelWisePredictionsChart'));
                    chart.setOption({
                        title: {
                            text: 'Channel-wise Predictions',
                            left: 'center'
                        },
                        graphic: {
                            type: 'text',
                            left: 'center',
                            top: 'middle',
                            style: {
                                text: 'Loading channel-wise predictions...',
                                fontSize: 16,
                                fill: '#666'
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to create channel-wise predictions chart:', error);
                const chart = echarts.init(document.getElementById('channelWisePredictionsChart'));
                chart.setOption({
                    title: {
                        text: 'Channel-wise Predictions',
                        left: 'center'
                    },
                    graphic: {
                        type: 'text',
                        left: 'center',
                        top: 'middle',
                        style: {
                            text: 'Unable to load channel-wise data',
                            fontSize: 16,
                            fill: '#e74c3c'
                        }
                    }
                });
            }
        }

        async function loadChannelWisePredictionsTable() {
            try {
                const response = await fetch(`${API_BASE}/predictions/channel-wise`);
                const data = await response.json();
                
                if (response.ok && data.data.predictions) {
                    const tableDiv = document.getElementById('channelWisePredictionsTable');
                    
                    let tableHtml = `
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                <thead>
                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                        <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">SKU</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Total Predicted</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Amazon<br/>Predicted</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Flipkart<br/>Predicted</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Amazon<br/>Confidence</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Flipkart<br/>Confidence</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.data.predictions.forEach(sku => {
                        const amazonData = sku.channels['Amazon Stores'];
                        const flipkartData = sku.channels['Flipkart Store'];
                        
                        const statusColor = sku.status === 'active' ? '#28a745' : '#6c757d';
                        const statusText = sku.status === 'active' ? 'Active' : 'Inactive';
                        
                        tableHtml += `
                            <tr style="border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: bold;">${sku.sku}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">${sku.total_predicted_quantity}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${amazonData.predicted_quantity}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${flipkartData.predicted_quantity}</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">
                                    <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; 
                                        background: ${amazonData.confidence === 'high' ? '#d4edda' : amazonData.confidence === 'medium' ? '#fff3cd' : '#f8d7da'};
                                        color: ${amazonData.confidence === 'high' ? '#155724' : amazonData.confidence === 'medium' ? '#856404' : '#721c24'};">
                                        ${amazonData.confidence}
                                    </span>
                                </td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">
                                    <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; 
                                        background: ${flipkartData.confidence === 'high' ? '#d4edda' : flipkartData.confidence === 'medium' ? '#fff3cd' : '#f8d7da'};
                                        color: ${flipkartData.confidence === 'high' ? '#155724' : flipkartData.confidence === 'medium' ? '#856404' : '#721c24'};">
                                        ${flipkartData.confidence}
                                    </span>
                                </td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">
                                    <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tableHtml += `
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="margin: 0 0 10px 0; color: #2c3e50;">üìä Summary</h4>
                            <p style="margin: 5px 0;"><strong>Total SKUs:</strong> ${data.data.summary.total_skus}</p>
                            <p style="margin: 5px 0;"><strong>Active SKUs:</strong> ${data.data.summary.active_skus}</p>
                            <p style="margin: 5px 0;"><strong>Total Predicted Quantity:</strong> ${data.data.summary.total_predicted_quantity.toLocaleString()} units</p>
                        </div>
                    `;
                    
                    tableDiv.innerHTML = tableHtml;
                } else {
                    document.getElementById('channelWisePredictionsTable').innerHTML = 
                        '<div class="error">Failed to load channel-wise predictions data</div>';
                }
            } catch (error) {
                console.error('Failed to load channel-wise predictions table:', error);
                document.getElementById('channelWisePredictionsTable').innerHTML = 
                    '<div class="error">Error loading channel-wise predictions table</div>';
            }
        }

        async function createModelComparisonChart() {
            try {
                // Create a mock model comparison chart
                const chart = echarts.init(document.getElementById('modelComparisonChart'));
                const option = {
                    title: {
                        text: 'Model Performance Comparison',
                        left: 'center',
                        top: '5%',
                        textStyle: {
                            fontSize: 16
                        }
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    legend: {
                        data: ['Random Forest', 'Linear Regression', 'Prophet', 'ARIMA'],
                        top: '15%',
                        left: 'center'
                    },
                    grid: {
                        top: '25%',
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: ['MAE', 'RMSE', 'MAPE', 'R¬≤']
                    },
                    yAxis: {
                        type: 'value'
                    },
                    series: [
                        {
                            name: 'Random Forest',
                            type: 'bar',
                            data: [12.5, 18.3, 15.2, 0.85],
                            itemStyle: { color: '#3498db' }
                        },
                        {
                            name: 'Linear Regression',
                            type: 'bar',
                            data: [15.8, 22.1, 18.7, 0.72],
                            itemStyle: { color: '#2ecc71' }
                        },
                        {
                            name: 'Prophet',
                            type: 'bar',
                            data: [14.2, 19.8, 16.5, 0.78],
                            itemStyle: { color: '#f39c12' }
                        },
                        {
                            name: 'ARIMA',
                            type: 'bar',
                            data: [16.1, 23.4, 19.3, 0.68],
                            itemStyle: { color: '#e74c3c' }
                        }
                    ]
                };
                chart.setOption(option);
                
                // Add model explanation table below the chart
                addModelExplanationTable();
            } catch (error) {
                console.error('Failed to create model comparison chart:', error);
            }
        }
        
        function addModelExplanationTable() {
            const chartContainer = document.getElementById('modelComparisonChart').parentElement;
            
            // Remove existing table if any
            const existingTable = chartContainer.querySelector('.model-explanation-table');
            if (existingTable) {
                existingTable.remove();
            }
            
            const tableHtml = `
                <div class="model-explanation-table" style="margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;">üìä Model Performance Metrics Explained</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                        <div>
                            <strong>üéØ MAE (Mean Absolute Error):</strong><br>
                            Average difference between predicted and actual values. Lower is better.
                        </div>
                        <div>
                            <strong>üìè RMSE (Root Mean Square Error):</strong><br>
                            Square root of average squared differences. Penalizes larger errors more.
                        </div>
                        <div>
                            <strong>üìä MAPE (Mean Absolute Percentage Error):</strong><br>
                            Average percentage error. Shows relative accuracy (lower % = better).
                        </div>
                        <div>
                            <strong>üîó R¬≤ (R-squared):</strong><br>
                            Proportion of variance explained. Closer to 1.0 = better fit.
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                        <strong>üèÜ Best Performing Model:</strong> Random Forest (Lowest MAE, Highest R¬≤)
                    </div>
                </div>
            `;
            
            chartContainer.insertAdjacentHTML('beforeend', tableHtml);
        }

        async function generateCustomForecast() {
            const sku = document.getElementById('forecastSku').value;
            const period = document.getElementById('forecastPeriod').value;
            const type = document.getElementById('forecastType').value;

            if (!sku) {
                showMessage('Please enter a SKU', 'error');
                return;
            }

            try {
                // For now, generate a mock forecast
                const mockForecast = generateMockForecast(sku, period, type);
                
                const resultDiv = document.getElementById('customForecastResult');
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>üéØ Custom Forecast Result</h3>
                        <p><strong>SKU:</strong> ${sku}</p>
                        <p><strong>Forecast Type:</strong> ${type}</p>
                        <p><strong>Period:</strong> ${period} month(s)</p>
                        <p><strong>Predicted Value:</strong> ${mockForecast.value}</p>
                        <p><strong>Confidence:</strong> ${mockForecast.confidence}</p>
                        <p><strong>Risk Level:</strong> ${mockForecast.risk}</p>
                    </div>
                `;
            } catch (error) {
                showMessage(`Forecast generation failed: ${error.message}`, 'error');
            }
        }

        function generateMockForecast(sku, period, type) {
            const baseValues = {
                'sales': { value: `${Math.floor(Math.random() * 1000 + 100)} units`, confidence: '85%' },
                'returns': { value: `${(Math.random() * 20 + 5).toFixed(1)}%`, confidence: '78%' },
                'revenue': { value: `‚Çπ${Math.floor(Math.random() * 100000 + 10000).toLocaleString()}`, confidence: '82%' },
                'inventory': { value: `${Math.floor(Math.random() * 500 + 50)} units`, confidence: '88%' }
            };
            
            const riskLevels = ['Low', 'Medium', 'High'];
            const risk = riskLevels[Math.floor(Math.random() * riskLevels.length)];
            
            return {
                ...baseValues[type],
                risk: risk
            };
        }

        // Analysis functionality
        async function loadAnalysisData() {
            try {
                // Load analysis stats
                await loadAnalysisStats();
                
                // Load comprehensive analysis charts
                await loadAnalysisCharts();
                
                // Load business intelligence summary
                await loadBusinessIntelligenceSummary();
                
                // Load business recommendations
                await loadBusinessRecommendations();
                
            } catch (error) {
                showMessage(`Failed to load analysis data: ${error.message}`, 'error');
            }
        }

        async function loadAnalysisStats() {
            try {
                // Get sales analysis
                const salesResponse = await fetch(`${API_BASE}/analysis`);
                const salesData = await salesResponse.json();
                
                // Get returns analysis
                const returnsResponse = await fetch(`${API_BASE}/returns/overview`);
                const returnsData = await returnsResponse.json();
                
                if (salesResponse.ok && returnsResponse.ok) {
                    displayAnalysisStats(salesData.data, returnsData.data);
                }
            } catch (error) {
                console.error('Failed to load analysis stats:', error);
            }
        }

        function displayAnalysisStats(salesData, returnsData) {
            const statsGrid = document.getElementById('analysisStatsGrid');
            const netRevenue = salesData.overview.total_revenue - returnsData.returns_revenue;
            const profitMargin = ((netRevenue / salesData.overview.total_revenue) * 100);
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>‚Çπ${salesData.overview.total_revenue.toLocaleString()}</h3>
                    <p>Gross Revenue</p>
                </div>
                <div class="stat-card">
                    <h3>‚Çπ${netRevenue.toLocaleString()}</h3>
                    <p>Net Revenue</p>
                </div>
                <div class="stat-card">
                    <h3>${profitMargin.toFixed(1)}%</h3>
                    <p>Profit Margin</p>
                </div>
                <div class="stat-card">
                    <h3>${returnsData.overall_return_rate.toFixed(1)}%</h3>
                    <p>Return Rate</p>
                </div>
                <div class="stat-card">
                    <h3>${salesData.overview.total_skus}</h3>
                    <p>Active SKUs</p>
                </div>
                <div class="stat-card">
                    <h3>${salesData.sales_performance.volatility.toFixed(1)}%</h3>
                    <p>Sales Volatility</p>
                </div>
            `;
        }

        async function loadAnalysisCharts() {
            // Create all analysis charts
            await createKPIChart();
            await createRevenueReturnsChart();
            await createCategoryPerformanceChart();
            await createSeasonalTrendsChart();
            await createProfitabilityChart();
            await createRiskAssessmentChart();
            await createCustomerBehaviorChart();
            await createInventoryOptimizationChart();
            await createStateChannelDistributionChart();
        }

        async function createKPIChart() {
            const chart = echarts.init(document.getElementById('kpiChart'));
            // Hide mock data - replace with "No Data Available" message
            chart.setOption({
                title: {
                    text: 'Key Performance Indicators',
                    left: 'center',
                    top: 'center',
                    textStyle: {
                        fontSize: 18,
                        color: '#666'
                    }
                },
                graphic: {
                    type: 'text',
                    left: 'center',
                    top: 'middle',
                    style: {
                        text: 'üìä KPI Data Not Available\n\nRequires:\n‚Ä¢ Historical quarterly data\n‚Ä¢ Profit margin calculations\n‚Ä¢ Return rate analysis',
                        fontSize: 14,
                        fill: '#999',
                        textAlign: 'center',
                        lineHeight: 20
                    }
                }
            });
        }

        async function createRevenueReturnsChart() {
            const chart = echarts.init(document.getElementById('revenueReturnsChart'));
            // Hide mock data - replace with "No Data Available" message
            chart.setOption({
                title: {
                    text: 'Revenue vs Returns Analysis',
                    left: 'center',
                    top: 'center',
                    textStyle: {
                        fontSize: 18,
                        color: '#666'
                    }
                },
                graphic: {
                    type: 'text',
                    left: 'center',
                    top: 'middle',
                    style: {
                        text: 'üìà Revenue vs Returns Data Not Available\n\nRequires:\n‚Ä¢ Monthly revenue breakdown\n‚Ä¢ Returns impact calculations\n‚Ä¢ Net revenue analysis',
                        fontSize: 14,
                        fill: '#999',
                        textAlign: 'center',
                        lineHeight: 20
                    }
                }
            });
        }

        async function createCategoryPerformanceChart() {
            const chart = echarts.init(document.getElementById('categoryPerformanceChart'));
            const option = {
                title: {
                    text: 'Top Performing Product Categories',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                series: [{
                    name: 'Revenue Share',
                    type: 'pie',
                    radius: '50%',
                    data: [
                        { value: 35, name: 'Electronics' },
                        { value: 25, name: 'Home & Garden' },
                        { value: 20, name: 'Fashion' },
                        { value: 15, name: 'Sports' },
                        { value: 5, name: 'Others' }
                    ],
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            chart.setOption(option);
        }

        async function createSeasonalTrendsChart() {
            const chart = echarts.init(document.getElementById('seasonalTrendsChart'));
            // Hide mock data - replace with "No Data Available" message
            chart.setOption({
                title: {
                    text: 'Seasonal Trends Analysis',
                    left: 'center',
                    top: 'center',
                    textStyle: {
                        fontSize: 18,
                        color: '#666'
                    }
                },
                graphic: {
                    type: 'text',
                    left: 'center',
                    top: 'middle',
                    style: {
                        text: 'üìÖ Seasonal Trends Data Not Available\n\nRequires:\n‚Ä¢ Multi-year historical data\n‚Ä¢ Seasonal pattern analysis\n‚Ä¢ Weather/event correlation',
                        fontSize: 14,
                        fill: '#999',
                        textAlign: 'center',
                        lineHeight: 20
                    }
                }
            });
        }

        async function createProfitabilityChart() {
            const chart = echarts.init(document.getElementById('profitabilityChart'));
            // Hide mock data - replace with "No Data Available" message
            chart.setOption({
                title: {
                    text: 'SKU Profitability Analysis',
                    left: 'center',
                    top: 'center',
                    textStyle: {
                        fontSize: 18,
                        color: '#666'
                    }
                },
                graphic: {
                    type: 'text',
                    left: 'center',
                    top: 'middle',
                    style: {
                        text: 'üí∞ Profitability Data Not Available\n\nRequires:\n‚Ä¢ Cost price data per SKU\n‚Ä¢ Profit margin calculations\n‚Ä¢ COGS analysis',
                        fontSize: 14,
                        fill: '#999',
                        textAlign: 'center',
                        lineHeight: 20
                    }
                }
            });
        }

        async function createRiskAssessmentChart() {
            const chart = echarts.init(document.getElementById('riskAssessmentChart'));
            const option = {
                title: {
                    text: 'Business Risk Assessment',
                    left: 'center',
                    top: 10,
                    textStyle: {
                        fontSize: 16,
                        color: '#1e293b'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}%'
                },
                series: [{
                    name: 'Risk Level',
                    type: 'gauge',
                    radius: '80%',
                    center: ['50%', '60%'],
                    startAngle: 200,
                    endAngle: -20,
                    min: 0,
                    max: 100,
                    splitNumber: 10,
                    itemStyle: {
                        color: '#ff6b6b'
                    },
                    progress: {
                        show: true,
                        width: 18
                    },
                    pointer: {
                        show: false
                    },
                    axisLine: {
                        lineStyle: {
                            width: 18
                        }
                    },
                    axisTick: {
                        distance: -30,
                        splitNumber: 5,
                        lineStyle: {
                            width: 2,
                            color: '#999'
                        }
                    },
                    splitLine: {
                        distance: -30,
                        length: 30,
                        lineStyle: {
                            width: 4,
                            color: '#999'
                        }
                    },
                    axisLabel: {
                        distance: -20,
                        color: '#999',
                        fontSize: 12
                    },
                    anchor: {
                        show: false
                    },
                    title: {
                        show: false
                    },
                    detail: {
                        valueAnimation: true,
                        formatter: '{value}%',
                        color: 'inherit',
                        fontSize: 20,
                        fontWeight: 'bold',
                        offsetCenter: [0, '70%']
                    },
                    data: [
                        { value: 65, name: 'Overall Risk' }
                    ]
                }]
            };
            chart.setOption(option);
        }

        async function createCustomerBehaviorChart() {
            try {
                // Get actual state-wise sales data from API
                const response = await fetch(`${API_BASE}/analysis/state-performance`);
                const data = await response.json();
                
                if (response.ok && data.data && data.data.state_performance) {
                    const stateData = data.data.state_performance.slice(0, 8); // Top 8 states
                    
                    const chart = echarts.init(document.getElementById('customerBehaviorChart'));
                    const option = {
                        title: {
                            text: 'Top States by Sales Volume',
                            left: 'center',
                            top: 10,
                            textStyle: {
                                fontSize: 16
                            }
                        },
                        tooltip: {
                            trigger: 'axis',
                            formatter: function(params) {
                                const param = params[0];
                                return `${param.name}<br/>Sales: ‚Çπ${param.value.toLocaleString()}`;
                            }
                        },
                        xAxis: {
                            type: 'category',
                            data: stateData.map(state => state.state),
                            axisLabel: {
                                rotate: 45
                            }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'Sales (‚Çπ)',
                            axisLabel: {
                                formatter: function(value) {
                                    return (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        },
                        series: [
                            {
                                name: 'Sales Revenue',
                                type: 'bar',
                                data: stateData.map(state => state.total_revenue),
                                itemStyle: { color: '#3498db' }
                            }
                        ]
                    };
                    chart.setOption(option);
                } else {
                    // Fallback to simple message if API fails
                    const chart = echarts.init(document.getElementById('customerBehaviorChart'));
                    chart.setOption({
                        title: {
                            text: 'State-wise Sales Analysis',
                            left: 'center'
                        },
                        graphic: {
                            type: 'text',
                            left: 'center',
                            top: 'middle',
                            style: {
                                text: 'Loading state sales data...',
                                fontSize: 16,
                                fill: '#666'
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to create customer behavior chart:', error);
                const chart = echarts.init(document.getElementById('customerBehaviorChart'));
                chart.setOption({
                    title: {
                        text: 'State-wise Sales Analysis',
                        left: 'center'
                    },
                    graphic: {
                        type: 'text',
                        left: 'center',
                        top: 'middle',
                        style: {
                            text: 'Unable to load state data',
                            fontSize: 16,
                            fill: '#e74c3c'
                        }
                    }
                });
            }
        }

        async function createInventoryOptimizationChart() {
            try {
                // Get actual SKU performance data from API
                const response = await fetch(`${API_BASE}/analysis/sku-performance`);
                const data = await response.json();
                
                if (response.ok && data.data && data.data.top_skus) {
                    const skuData = data.data.top_skus.slice(0, 8); // Top 8 SKUs
                    
                    const chart = echarts.init(document.getElementById('inventoryOptimizationChart'));
                    const option = {
                        title: {
                            text: 'Top SKUs by Sales Performance',
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'axis',
                            formatter: function(params) {
                                let result = params[0].name + '<br/>';
                                params.forEach(param => {
                                    if (param.seriesName === 'Quantity Sold') {
                                        result += `${param.seriesName}: ${param.value.toLocaleString()} units<br/>`;
                                    } else {
                                        result += `${param.seriesName}: ‚Çπ${param.value.toLocaleString()}<br/>`;
                                    }
                                });
                                return result;
                            }
                        },
                        legend: {
                            data: ['Quantity Sold', 'Revenue'],
                            top: 30
                        },
                        xAxis: {
                            type: 'category',
                            data: skuData.map(sku => sku.sku),
                            axisLabel: {
                                rotate: 45
                            }
                        },
                        yAxis: [
                            {
                                type: 'value',
                                name: 'Quantity',
                                position: 'left'
                            },
                            {
                                type: 'value',
                                name: 'Revenue (‚Çπ)',
                                position: 'right',
                                axisLabel: {
                                    formatter: function(value) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    }
                                }
                            }
                        ],
                        series: [
                            {
                                name: 'Quantity Sold',
                                type: 'bar',
                                yAxisIndex: 0,
                                data: skuData.map(sku => sku.total_quantity),
                                itemStyle: { color: '#3498db' }
                            },
                            {
                                name: 'Revenue',
                                type: 'line',
                                yAxisIndex: 1,
                                data: skuData.map(sku => sku.total_revenue),
                                itemStyle: { color: '#2ecc71' },
                                lineStyle: { width: 3 }
                            }
                        ]
                    };
                    chart.setOption(option);
                } else {
                    // Fallback message if API fails
                    const chart = echarts.init(document.getElementById('inventoryOptimizationChart'));
                    chart.setOption({
                        title: {
                            text: 'SKU Performance Analysis',
                            left: 'center'
                        },
                        graphic: {
                            type: 'text',
                            left: 'center',
                            top: 'middle',
                            style: {
                                text: 'Loading SKU performance data...',
                                fontSize: 16,
                                fill: '#666'
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to create inventory optimization chart:', error);
                const chart = echarts.init(document.getElementById('inventoryOptimizationChart'));
                chart.setOption({
                    title: {
                        text: 'SKU Performance Analysis',
                        left: 'center'
                    },
                    graphic: {
                        type: 'text',
                        left: 'center',
                        top: 'middle',
                        style: {
                            text: 'Unable to load SKU data',
                            fontSize: 16,
                            fill: '#e74c3c'
                        }
                    }
                });
            }
        }

        async function createStateChannelDistributionChart() {
            try {
                const response = await fetch(`${API_BASE}/analysis/state-channel-distribution`);
                const data = await response.json();
                
                if (response.ok && data.data.state_distribution) {
                    const chart = echarts.init(document.getElementById('stateChannelDistributionChart'));
                    
                    // Get top 10 states for better visualization
                    const topStates = data.data.state_distribution.slice(0, 10);
                    
                    // Prepare data for stacked bar chart
                    const amazonData = [];
                    const flipkartData = [];
                    const stateNames = [];
                    
                    topStates.forEach(state => {
                        stateNames.push(state.state);
                        amazonData.push(state.amazon_quantity);
                        flipkartData.push(state.flipkart_quantity);
                    });
                    
                    const option = {
                        title: {
                            text: 'State-wise Channel Distribution (Top 10 States)',
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            },
                            formatter: function(params) {
                                let result = params[0].name + '<br/>';
                                let total = 0;
                                params.forEach(param => {
                                    result += `${param.seriesName}: ${param.value.toLocaleString()} units<br/>`;
                                    total += param.value;
                                });
                                result += `Total: ${total.toLocaleString()} units`;
                                return result;
                            }
                        },
                        legend: {
                            data: ['Amazon Stores', 'Flipkart Store'],
                            top: 30
                        },
                        xAxis: {
                            type: 'category',
                            data: stateNames,
                            axisLabel: {
                                rotate: 45
                            }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'Quantity Sold'
                        },
                        series: [
                            {
                                name: 'Amazon Stores',
                                type: 'bar',
                                stack: 'total',
                                data: amazonData,
                                itemStyle: { color: '#ff9900' }
                            },
                            {
                                name: 'Flipkart Store',
                                type: 'bar',
                                stack: 'total',
                                data: flipkartData,
                                itemStyle: { color: '#2874f0' }
                            }
                        ]
                    };
                    chart.setOption(option);
                } else {
                    // Fallback message if API fails
                    const chart = echarts.init(document.getElementById('stateChannelDistributionChart'));
                    chart.setOption({
                        title: {
                            text: 'State-wise Channel Distribution',
                            left: 'center'
                        },
                        graphic: {
                            type: 'text',
                            left: 'center',
                            top: 'middle',
                            style: {
                                text: 'Loading state-channel distribution...',
                                fontSize: 16,
                                fill: '#666'
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to create state-channel distribution chart:', error);
                const chart = echarts.init(document.getElementById('stateChannelDistributionChart'));
                chart.setOption({
                    title: {
                        text: 'State-wise Channel Distribution',
                        left: 'center'
                    },
                    graphic: {
                        type: 'text',
                        left: 'center',
                        top: 'middle',
                        style: {
                            text: 'Unable to load state-channel data',
                            fontSize: 16,
                            fill: '#e74c3c'
                        }
                    }
                });
            }
        }

        async function loadBusinessIntelligenceSummary() {
            const analysisContent = document.getElementById('analysisContent');
            analysisContent.innerHTML = '<div class="loading">Loading business intelligence...</div>';

            try {
                const response = await fetch(`${API_BASE}/analysis`);
                const result = await response.json();

                if (response.ok) {
                    displayAnalysis(result.data);
                } else {
                    analysisContent.innerHTML = `<div class="error">Error: ${result.detail}</div>`;
                }
            } catch (error) {
                analysisContent.innerHTML = `<div class="error">Failed to load analysis: ${error.message}</div>`;
            }
        }

        async function loadBusinessRecommendations() {
            const recommendationsDiv = document.getElementById('businessRecommendations');
            recommendationsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; border-left: 4px solid #27ae60;">
                        <h3>üéØ Immediate Actions</h3>
                        <ul>
                            <li>Address high return rate (36.08%) - investigate quality issues</li>
                            <li>Optimize inventory for top 5 SKUs</li>
                            <li>Implement return prevention strategies</li>
                            <li>Review pricing for low-margin products</li>
                        </ul>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #f39c12;">
                        <h3>üìà Growth Opportunities</h3>
                        <ul>
                            <li>Expand in high-performing states (Maharashtra, Karnataka)</li>
                            <li>Focus on best-performing months (October, November)</li>
                            <li>Develop seasonal product strategies</li>
                            <li>Improve customer retention programs</li>
                        </ul>
                    </div>
                    
                    <div style="background: #f8d7da; padding: 20px; border-radius: 10px; border-left: 4px solid #e74c3c;">
                        <h3>‚ö†Ô∏è Risk Mitigation</h3>
                        <ul>
                            <li>Monitor high-risk SKUs (LTF-01, LTF-02)</li>
                            <li>Implement quality control measures</li>
                            <li>Diversify supplier base</li>
                            <li>Create contingency plans for demand spikes</li>
                        </ul>
                    </div>
                    
                    <div style="background: #d1ecf1; padding: 20px; border-radius: 10px; border-left: 4px solid #17a2b8;">
                        <h3>üí∞ Financial Optimization</h3>
                        <ul>
                            <li>Reduce return-related revenue loss (‚Çπ242.8M)</li>
                            <li>Optimize inventory carrying costs</li>
                            <li>Implement dynamic pricing strategies</li>
                            <li>Focus on high-margin SKUs</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function displayAnalysis(data) {
            const analysisContent = document.getElementById('analysisContent');
            analysisContent.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>üìà Sales Performance</h3>
                        <p><strong>Daily Average:</strong> ${data.sales_performance.daily_average.toFixed(0)} units</p>
                        <p><strong>Peak Daily:</strong> ${data.sales_performance.peak_daily} units</p>
                        <p><strong>Volatility:</strong> ${data.sales_performance.volatility.toFixed(1)}%</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>üì¶ Top SKUs</h3>
                        ${data.top_skus.slice(0, 5).map(sku => 
                            `<p><strong>${sku.sku}:</strong> ${sku.quantity.toLocaleString()} units</p>`
                        ).join('')}
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>üó∫Ô∏è Top States</h3>
                        ${data.top_states.slice(0, 5).map(state => 
                            `<p><strong>${state.state}:</strong> ‚Çπ${state.revenue.toLocaleString()}</p>`
                        ).join('')}
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>‚è∞ Temporal Patterns</h3>
                        <p><strong>Best Day:</strong> ${data.temporal_patterns.best_day}</p>
                        <p><strong>Worst Day:</strong> ${data.temporal_patterns.worst_day}</p>
                        <p><strong>Best Month:</strong> ${data.temporal_patterns.best_month}</p>
                        <p><strong>Worst Month:</strong> ${data.temporal_patterns.worst_month}</p>
                    </div>
                </div>
            `;
        }

        // Load SKU data
        async function loadSkuData() {
            try {
                const response = await fetch(`${API_BASE}/skus`);
                const result = await response.json();
                
                if (response.ok) {
                    skuList = result.data;
                    populateSkuDropdowns();
                }
            } catch (error) {
                console.error('Failed to load SKU data:', error);
            }
        }

        // Populate SKU dropdowns
        function populateSkuDropdowns() {
            // Update prediction dropdown
            const predSkuSelect = document.getElementById('predSku');
            if (predSkuSelect) {
                predSkuSelect.innerHTML = '<option value="">Select SKU...</option>';
                skuList.forEach(sku => {
                    const option = document.createElement('option');
                    option.value = sku.sku;
                    option.textContent = sku.display;
                    predSkuSelect.appendChild(option);
                });
            }

            // Update forecasting dropdown
            const forecastSkuSelect = document.getElementById('forecastSku');
            if (forecastSkuSelect) {
                forecastSkuSelect.innerHTML = '<option value="">Select SKU...</option>';
                skuList.forEach(sku => {
                    const option = document.createElement('option');
                    option.value = sku.sku;
                    option.textContent = sku.display;
                    forecastSkuSelect.appendChild(option);
                });
            }
        }

        // Load current file information
        async function loadCurrentFileInfo() {
            try {
                const response = await fetch(`${API_BASE}/analysis`);
                const result = await response.json();
                
                if (response.ok) {
                    const data = result.data;
                    const fileInfo = document.getElementById('fileInfo');
                    
                    if (fileInfo) {
                        fileInfo.innerHTML = `
                            <h3>üìÑ File Information</h3>
                            <p><strong>File:</strong> Sales-Table 1.csv</p>
                            <p><strong>Records:</strong> ${data.overview.total_records.toLocaleString()}</p>
                            <p><strong>SKUs:</strong> ${data.overview.total_skus}</p>
                            <p><strong>Revenue:</strong> ‚Çπ${data.overview.total_revenue.toLocaleString()}</p>
                            <p><strong>Quantity:</strong> ${data.overview.total_quantity.toLocaleString()}</p>
                        `;
                        fileInfo.style.display = 'block';
                    }
                } else {
                    console.error('API response not ok:', result);
                }
            } catch (error) {
                console.error('Failed to load file info:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load SKU data
            loadSkuData();
        });
    </script>
</body>
</html>
